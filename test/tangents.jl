using GeneralizedSP2: LAYER_WIDTH, manualdiff_model!
using DifferentiationInterface: AutoMooncake
using Mooncake

@testset "Test computing the model's gradients" begin
    model = Model(rand(4, 10))
    𝐱 = rand(100)

    f(x) = x^3 + 2.5x^2 + 4x
    f′(x) = 3x^2 + 5x + 4
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    f(y) = exp(y)
    f′(y) = exp(y)
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    f(y) = sin(y)
    f′(y) = cos(y)
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    f(y) = log(y)
    f′(y) = 1 / y
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    f(y) = tanh(y)
    f′(y) = 1 - tanh(y)^2
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    f(y) = 1 / y
    f′(y) = -1 / y^2
    𝐱 = rand(100)
    𝝝̄ = manualdiff_model(f′, 𝐱, model)  # Benchmark result
    @test autodiff_model(f, 𝐱, model) ≈ 𝝝̄

    @testset "Custom example" begin
        model = Model(
            FlattendModel([
                1.068683693753838,
                0.00043713417546797413,
                -0.023669330653795728,
                9.005720913793814e-5,
                -0.8988352852282151,
                2.0939322727244716,
                -0.01850466847165241,
                -0.00018805667183951022,
                1.121043839840355,
                -0.039193579482772516,
                -0.0713911287405517,
                -5.373142250321436e-5,
                -1.1833278609427365,
                2.1766052653095267,
                -0.062387077814170536,
                9.929793332669317e-5,
                1.2743833310021198,
                -0.12155739652891523,
                -0.041866994988454975,
                4.831831668351596e-6,
                -1.9741954353373359,
                2.5488456964347885,
                -0.011579870151428822,
                -2.2915853506309004e-5,
                -1.4836213879000744,
                2.0715954262875185,
                0.014762912549470094,
                -5.4504017574035155e-5,
                1.254394828359412,
                0.04539707864432702,
                -0.03583519135734237,
                -3.4814915497598705e-6,
                1.6120142220103624,
                -0.02863687597071174,
                -0.007278948894143404,
                -0.00013604148922537115,
                -1.8355781265491242,
                2.4658089013837734,
                0.03630734091825291,
                -0.00014948033179263998,
                -1.1481782598833667,
                1.9499184178466427,
                -0.02633181133440263,
                -0.013656943782122725,
                0.9866837162128639,
                -0.012725744165745833,
                0.3476628303166704,
                0.008001569193392533,
                -1.0299401947962237,
                1.9910652233933195,
                -0.0073284213421279856,
                -0.2935784995402061,
                0.9886550954234288,
                -0.0003658095247356059,
                0.01044282800685964,
                0.0320852082324717,
                0.9758776109106394,
                0.05265594653718487,
                0.46565341599567633,
                -0.019977579828817118,
                -1.3230586361674694,
                1.7445963787152794,
                0.09166173712648211,
                0.023313554911775756,
                -1.1812921206616553,
                2.0233340584172343,
                0.040045158329528194,
                0.17244366416642706,
                0.9316110426422627,
                0.057331273828960555,
                0.17505750591193034,
                0.057331273828960534,
            ]),
        )
        x = [0.35]
        derivatives = Array{Float64}(undef, length(x), size(model)...)
        benchmark =
            dropdims(manualdiff_model!(identity, derivatives, x, model); dims=1) ≈ [
                -2.71684319022536e-5 -2.046495813445744e-7 3.454300120807116e-6 -5.3809070335681494e-9 3.7558823185086665e-7 2.4600414326836435e-11 2.4121698281447507e-9 7.91943678702916e-9 -9.927325694762909e-6 -5.26584199408108e-8 3.8000460150744053e-6 -3.919660087446929e-5 0.02119852573047765 0.040578382284137085 0.022617807459720637 0.3309787619316428 0.746273233154115 0.7403847532861861
                -7.762409114929601e-5 -1.9055353810694753e-6 1.762299999195879e-5 1.494584863616611e-7 -2.6396981752140378e-6 2.0024880824179023e-8 -2.854094385312919e-7 -2.7774021175948465e-6 0.0002761084999857477 1.2641740634491465e-5 0.00014613138380632364 -0.0016610102658272318 0.06093071507939602 0.07236832174828145 0.07044334839285092 0.5675565841004871 1.1322584427846258 0.8604553580087236
                -0.00022178311756941717 -1.7742841517930406e-5 8.990826443997958e-5 -4.151314825951626e-6 1.855224915299018e-5 1.6300369851296727e-5 3.376982277628385e-5 0.0009740544347111454 -0.007679399881540843 -0.0030349107787394037 0.00561950598714867 -0.07038761121198388 0.1751325581452539 0.1290631537746172 0.2193963911680529 0.9732360900616972 1.7178817681007654 0.999998203420236
                0.3499993711970826 0.1073972258444339 0.19601054964861725 -0.03600262184723799 -0.142284281060351 0.0012284902140604092 -0.008451596789868543 -0.0028513777349558904 -0.03595437250226953 -0.004165433136010341 0.02600426471718795 0.023598006141839416 0.3479113550204116 0.5607192263346944 0.321077395397077 0.5831632943285464 0.6591003115678945 0.8604553580087236
            ]
        @test reshape(
            autodiff_model(model, x, AutoMooncake(; config=nothing)), LAYER_WIDTH, :,
        ) ≈ benchmark
    end
end
